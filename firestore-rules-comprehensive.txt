rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read/write their own user documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Main shops collection rules
    match /shops/{shopId} {
      // Allow authenticated users to read and write shop documents
      allow read, write: if request.auth != null;
      
      // Products subcollection under shops
      match /products/{productId} {
        // Allow authenticated users to read and write products
        allow read, write: if request.auth != null;
        
        // Individual sales subcollection under products (used by sales.jsx and payments.jsx)
        match /sales/{saleId} {
          allow read, write: if request.auth != null;
        }
      }
      
      // Consolidated sales subcollection under shops (used by productAndDetail.jsx for table display)
      match /sales/{saleId} {
        allow read, write: if request.auth != null;
      }
      
      // Payments subcollection under shops
      match /payments/{paymentId} {
        allow read, write: if request.auth != null;
      }
    }
  }
}

// IMPLEMENTATION NOTES:
// 
// DUAL STORAGE STRUCTURE:
// The app now uses a dual storage approach to support both batch entry and individual payments:
//
// 1. INDIVIDUAL SALES (for payments system):
//    - Path: shops/{shopId}/products/{productId}/sales/{saleId}
//    - Used by: sales.jsx, payments.jsx
//    - Contains: {date, quantity, rate, total, productName, userId, createdAt}
//
// 2. CONSOLIDATED SALES (for batch entry display):
//    - Path: shops/{shopId}/sales/{saleId}
//    - Used by: productAndDetail.jsx
//    - Contains: {date, quantities: {productId: quantity}, userId, createdAt}
//
// DATA FLOW:
// - productAndDetail.jsx: Creates both individual and consolidated records
// - payments.jsx: Reads individual sales records from products/{productId}/sales
// - sales.jsx: Manages individual sales records per product
//
// SECURITY:
// - All operations require authentication (request.auth != null)
// - Users can access any shop data
//
// DEPLOYMENT:
// Copy the rules section (without comments) to Firebase Console > Firestore > Rules
